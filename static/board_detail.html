<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>My Blog - 게시글 상세</title>

    <script src="https://code.jquery.com/jquery-3.5.1.js"
        integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
        integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js"
        integrity="sha384-w1Q4orYjBQndcko6MimVbzY0tgp4pWB4lZ7lr30WKz0vr/aWKhXdBNmNb5D92v7s"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.js"></script>
    <script src="https://cdn.socket.io/socket.io-3.0.1.min.js"></script>

</head>
<body>
    <div align="center" >
        <table border="1">
            <tr>
                <td colspan="2" align="right">
                    <button id="btnUpdate">수정하기</button>
                    <!-- <button id="btnDelete">삭제하기</button> -->
                </td>
            </tr>
            <tr>
                <td>제목 : </td>
                <td><label id="lbTitle"></label></td>
            </tr>
            <tr>
                <td>작성자 : </td>
                <td><label id="lbRegId"></label></td>
            </tr>
            <tr>
                <td>작성일자 : </td>
                <td><label id="lbRegDt"></label></td>
            </tr>
            <tr>
                <td>글 내용 : </td>
                <td><textarea style="width: 500px; height: 200px;" id="taContent" readonly></textarea></td>
            </tr>
        </table>
    </div>
    <input type="hidden" id="ipBoardId">
    <div align="center">
        <button onclick="window.location.href='/'">돌아가기</button>
    </div>

    <div align="center">
        <table border="1">
            <tr>
                <td>댓글작성</td>
                <td>
                    <textarea id="taComment"></textarea>
                </td>
                <td>
                    <button id="btnSaveComment" 
                    onclick="requestSaveComment(getParameter('boardId'), $('#taComment').val())">작성하기</button>
                </td>
            </tr>
        </table>
    </div>

    <div align="center">
        <table id="tblComment"></table>
    </div>

    <script src="/api.js"></script>
    <script>

        function getParameter(name) {
            name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
            var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
                results = regex.exec(location.search);
            return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
        }

        function showCommentUpdate(commentId){
            $('#comment_'+commentId).hide();
            $('#commentUpdate_'+commentId).show();
            $('#btnCommentUpdate_'+commentId).hide();
        }

        function hideCommentUpdate(commentId){
            $('#comment_'+commentId).show();
            $('#commentUpdate_'+commentId).hide();
            $('#btnCommentUpdate_'+commentId).show();
        }

        $(document).ready(function () {

            let boardId = getParameter('boardId');
            

            requestBoardDetail(boardId, (response) => {
                $('#lbTitle').text(response.title);
                $('#lbRegId').text(response.regid);
                $('#lbRegDt').text(response.regdt);
                $('#taContent').text(response.content);
                $('#ipBoardId').val(response._id);
            })

            if(localStorage.getItem('token')){ // 로그인한 상태
                tokenCheck((u) => {
                    requestSelectComment(boardId, (response) => {
                        
                        for(let i = 0; i < response.length; i++){
                            let temp_html;

                            let userIds = response[i]['userId'];
                            let commentId = response[i]['commentId'];
                            let comment = response[i]['comment'];
                            let regdt = response[i]['regdt'];

                            
                            if(u.userId === userIds){
                                temp_html = `<tr>
                                                    <td>${userIds}</td>
                                                    <td id="comment_${commentId}">${comment}</td>
                                                    <td id="commentUpdate_${commentId}">
                                                        <input type="text" id="ipUpdateComment_${commentId}" value="${comment}">
                                                        <button onclick="requestUpdateComment('${boardId}', ${commentId})">수정</button>
                                                        <button onclick="hideCommentUpdate(${commentId})">취소</button>
                                                    </td>
                                                    <td>${regdt}</td>
                                                    <td><button id="btnCommentUpdate_${commentId}" onclick="showCommentUpdate(${commentId})">수정</button></td>
                                                    <td><button onclick="requestDeleteComment('${boardId}', ${commentId})">삭제</button></td>
                                                </tr>`;
                            }else{
                                temp_html = `<tr>
                                                    <td>${userIds}</td>
                                                    <td>${comment}</td>
                                                    <td>${regdt}</td>
                                                    <td></td>
                                                    <td></td>
                                                </tr>`;
                            }
                            $('#tblComment').append(temp_html);
                            $('#commentUpdate_'+commentId).hide();
                        }
                    });
                });
            }else{ // 로그인하지 않은 상태
                requestSelectComment(boardId, (response) => {
                    for(let i = 0; i < response.length; i++){
                        let temp_html = `<tr>
                                            <td>${response[i]['userId']}</td>
                                            <td>${response[i]['comment']}</td>
                                            <td>${response[i]['regdt']}</td>
                                            <td></td>
                                            <td></td>
                                        </tr>`
                        $('#tblComment').append(temp_html);
                    }
                });
            }
            

            $("#btnUpdate").on("click", function () {
                window.location.href = `/board_update.html?boardId=${ $('#ipBoardId').val() }`
            });

        });
    </script>
</body>
</html>